$(document).ready(function(){	/*fixBug Don't know why*/	$(".dropdown-toggle").dropdown();	var navListChildren = $('.nav-list > li');	var searchConditionBtn = $('#searchConditionBtn');	var tableBody = $('tbody')	var keywordTable = $('#keywordTable');	var pagination = $('.pagination');	var $form = $('#myform');	var file_input = $form.find('input[type=file]');	var upload_in_progress = false;	var prevPage = $('.prevPage');	var nextPage = $('.nextPage');	var deleteInfo = $('#deleteInfo');	var uploadProgress = $('#uploadProgress');	var exeProgress = $('#exeProgress');	var GLOBAL_CURPAGE =1;	var GLOBAL_TOTALPAGE = 1;	var GLOBAL_CONDITION = {		'field': null,		'input': '',		'symbol': '=',	};	var GLOBAL_PROGRESS = null;	$('#file-input').ace_file_input({		style:'well',		droppable: true	});	$('#addWordsForm').on('reset', function() {		$('#file_input').ace_file_input('reset_input');	});	navListChildren.on('click', function(){		navListChildren.removeClass('active');		$(this).addClass('active');	});	$('#navTabs a').click(function (e) {		e.preventDefault();		$(this).tab('show');	});	$('.searchCondition li').on('click', function(){		$(this).parents('.input-group-btn').children('button').text($(this).text());	});	prevPage.on('click', function(){		if (GLOBAL_CURPAGE > 1) {			GLOBAL_CURPAGE--;			queryData(GLOBAL_CURPAGE, GLOBAL_CONDITION);		} else {			bootbox.confirm("已经是第一页啦!", function() {			});		}	});	nextPage.on('click', function(){		if (GLOBAL_CURPAGE < GLOBAL_TOTALPAGE) {			GLOBAL_CURPAGE++;			queryData(GLOBAL_CURPAGE, GLOBAL_CONDITION);		} else {			bootbox.confirm("已经是最后一页啦!", function() {			});		}	});	$('#keywordSearchBtn').on('click', function(){		var field = $('#searchConditionBtn').text();		var symbol = $('#searchSymbolBtn').text();		var input = $('#searchInput').val();		if (input == '') {			bootbox.confirm("服务器不知道您要搜索什么, 请填写搜索条件哦", function() {			});			} else {			GLOBAL_CONDITION.field = field;			GLOBAL_CONDITION.input = input;			GLOBAL_CONDITION.symbol = symbol;			GLOBAL_CURPAGE = 1;			queryData(GLOBAL_CURPAGE, GLOBAL_CONDITION);		}	});	$('.selectAll').on('change', function(){		if(this.checked) {			$('.selectSingle').prop('checked', true);		} else {			$('.selectSingle').prop('checked', false);		}		refreshDeleteInfo();	});	$(document).on('change', '.selectSingle', function(){		refreshDeleteInfo();	})	$('#delNav').on('click', function(){		$('.selectCell').show();		$('#deleteWell').show();		$('#searchWell').hide();	});	$('#deleteConfirm').on('click', function(){		if (deleteInfo.text() == 0) {			bootbox.confirm(" 服务器不知道您想删除哪些数据, 请先勾选目标数据", function() {			});		} else {			var checkeds = $('.selectSingle:checked');			var deleteArray = [];			checkeds.each(function(){				deleteArray.push($(this).parents('td').siblings('#dataName').text());			});			deleteData(deleteArray);			queryData(GLOBAL_CURPAGE, GLOBAL_CONDITION);		}	});	$('#addNav').on('click', function(){		$('.selectCell').hide();		$('#deleteWell').hide();		$('#searchWell').show();	});	queryData(GLOBAL_CURPAGE, GLOBAL_CONDITION);	// file upload	file_input.ace_file_input({		style : 'well',		btn_choose : 'Select or drop files here',		btn_change: null,		droppable: true,		thumbnail: 'large',		before_remove: function() {			if(upload_in_progress)				return false;//if we are in the middle of uploading a file, don't allow resetting file input			return true;		},		before_change: function(files, dropped) {			// var file = files[0];			// if(typeof file == "string") {//files is just a file name here (in browsers that don't support FileReader API)			// 	if(! (/\.(jpe?g|png|gif)$/i).test(file) ) {			// 		alert('Please select an image file!');			// 		return false;			// 	}			// }			// else {			// 	var type = $.trim(file.type);			// 	if( ( type.length > 0 && ! (/^image\/(jpe?g|png|gif)$/i).test(type) )			// 		|| ( type.length == 0 && ! (/\.(jpe?g|png|gif)$/i).test(file.name) )//for android's default browser!			// 	) {			// 		alert('Please select an image file!');			// 		return false;			// 	}			// 	if( file.size > 110000 ) {//~100Kb			// 		alert('File size should not exceed 100Kb!');			// 		return false;			// 	}			// }			return true;		}	});	$form.on('submit', function() {		GLOBAL_PROGRESS = setInterval(updateProgress, 1000);		var submit_url = $form.attr('action');		if(!file_input.data('ace_input_files')) return false;//no files selected		var deferred ;		if( "FormData" in window ) {			//for modern browsers that support FormData and uploading files via ajax			var fd = new FormData($form.get(0));			//if file has been drag&dropped , append it to FormData			if(file_input.data('ace_input_method') == 'drop') {				var files = file_input.data('ace_input_files');				if(files && files.length > 0) {					fd.append(file_input.attr('name'), files[0]);					//to upload multiple files, the 'name' attribute should be something like this: myfile[]				}			}			upload_in_progress = true;			deferred = $.ajax({				url: submit_url,				type: $form.attr('method'),				processData: false,				contentType: false,				dataType: 'json',				data: fd,				xhr: function() {					var req = $.ajaxSettings.xhr();					if (req && req.upload) {						req.upload.addEventListener('progress', function(e) {							if(e.lengthComputable) {								var done = e.loaded || e.position, total = e.total || e.totalSize;								var percent = parseInt((done/total)*100) + '%';								uploadProgress.width(percent);							}						}, false);					}					return req;				},				beforeSend : function() {				},				success : function() {				}			})		}		else {			//for older browsers that don't support FormData and uploading files via ajax			//we use an iframe to upload the form(file) without leaving the page			upload_in_progress = true;			deferred = new $.Deferred			var iframe_id = 'temporary-iframe-'+(new Date()).getTime()+'-'+(parseInt(Math.random()*1000));			$form.after('<iframe id="'+iframe_id+'" name="'+iframe_id+'" frameborder="0" width="0" height="0" src="about:blank" style="position:absolute;z-index:-1;"></iframe>');			$form.append('<input type="hidden" name="temporary-iframe-id" value="'+iframe_id+'" />');			$form.next().data('deferrer' , deferred);//save the deferred object to the iframe			$form.attr({'method' : 'POST', 'enctype' : 'multipart/form-data',				'target':iframe_id, 'action':submit_url});			$form.get(0).submit();			//if we don't receive the response after 60 seconds, declare it as failed!			setTimeout(function(){				var iframe = document.getElementById(iframe_id);				if(iframe != null) {					iframe.src = "about:blank";					$(iframe).remove();					deferred.reject({'status':'fail','message':'Timeout!'});				}			} , 60000);		}		////////////////////////////		deferred.done(function(result){			upload_in_progress = false;			if(result.status == 'OK') {				var info = "文件成功解析, 尝试添加" + result.info.tryCount + "条数据, 其中重复数据" + result.info.duplicateCount + "条, 最终成功添加" + result.info.successCount + "条";				bootbox.confirm(info , function() {					uploadProgress.width('0%');					exeProgress.width('0%');				});			}			else {				bootbox.confirm("文件上传解析失败, " + result.message, function() {				});			}		}).fail(function(res){			upload_in_progress = false;			bootbox.confirm("啊,好像出错了TAT", function() {			});			document.write(res.responseText);		});		deferred.promise();		return false;	});	$form.on('reset', function() {		file_input.ace_file_input('reset_input');	});	if(location.protocol == 'file:') alert("For uploading to server, you should access this page using a webserver.");	function createTrHTMLEle(value){		var res = '<tr><td class="center selectCell"> <label> <input type="checkbox" class="ace selectSingle"/> <span' +			' class="lbl"></span> </label>' +			' </td>';		res += '<td id="dataName">' + value.name +'</td>';		res += '<td>' + value.PCUrl +'</td>';		res += '<td>' + rankTranslate(value.PCRank) +'</td>';		res += '<td>' + value.PCCatchStatus +'</td>';		res += '<td>' + value.PCSEMUrl +'</td>';		res += '<td>' + rankTranslate(value.PCSEMRank) +'</td>';		res += '<td>' + value.mobileUrl +'</td>';		res += '<td>' + rankTranslate(value.mobileRank) +'</td>';		res += '<td>' + value.mobileCatchStatus +'</td>';		res += '<td>' + value.mobileSEMUrl +'</td>';		res += '<td>' + rankTranslate(value.mobileSEMRank) +'</td>';		res += '<td>' + '朱晓晔' +'</td>';		res += '<td>' + value.created_at +'</td>';		res += '<td>' + value.updated_at +'</td>';		res += '</tr>';		return res;	}	function rankTranslate(rank) {		switch(rank) {			case undefined:				return '尚未爬取';			case -1:				return '未收录';			case -2:				return '∞';			default:				return rank;		}	}	function queryData(curPage, condition) {		$.ajax({			url: '/query/keyword/',			type: 'GET',			dataType: 'json',			data:{				curPage:curPage,				condition:condition			}		}).done(function(msg) {			tableBody.empty();			for(var msgIndex in msg.data) {				GLOBAL_TOTALPAGE = msg.totalPage;				tableBody.append(createTrHTMLEle(msg.data[msgIndex]));			}			refreshKeywordTableHeader(msg.totalNum);			$('.selectCell').hide();		});	}	function deleteData(deleteArray) {		$.ajax({			url: '/delete/keyword/',			type: 'GET',			dataType: 'json',			data:{				deleteArray: deleteArray			}		}).done(function(msg){			bootbox.confirm('成功删除'+ msg.count +'条数据', function() {			});		});	}	function refreshKeywordTableHeader (num) {		if(GLOBAL_CONDITION.field) {			$('#header-condition').text('当前显示 ' + GLOBAL_CONDITION.field + GLOBAL_CONDITION.symbol + GLOBAL_CONDITION.input + '的结果');		} else {			$('#header-condition').text('当前显示默认查询结果');		}		$('#header-num').text('共'+ num + '条数据');		$('#header-cur').text('当前第'+ GLOBAL_CURPAGE + '页');		$('#header-total').text('共' + GLOBAL_TOTALPAGE + '页');	}	function refreshDeleteInfo() {		deleteInfo.text(getNumOfSelected());	}	function getNumOfSelected() {		return $(".selectSingle:checked").length;	}	function updateProgress() {		$.ajax({			url: '/upload/progress/',			type: 'GET'		}).done(function(msg){			exeProgress.width(msg.percent + '%');			if (msg.percent == 100) {				clearInterval(GLOBAL_PROGRESS);			}		});	}});